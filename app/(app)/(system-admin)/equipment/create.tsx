import ProfilePic from "@/components/ProfilePic";
import { useEquipment } from "@/stores/equipmentStore";
import { prepareImageForUpload } from "@/utils/prepareImageForUpload";
import { useNavigation } from "expo-router";
import React, { useCallback, useEffect, useState } from "react";
import {
  Keyboard,
  Platform,
  ScrollView,
  Text,
  TextInput,
  useColorScheme,
  View,
} from "react-native";
import Toast from "react-native-toast-message";

export default function CreateEquipment() {
  const navigation = useNavigation();
  const isDarkMode = useColorScheme() === "dark";

  const createEquipment = useEquipment((s) => s.createEquipment);
  const refreshEquipment = useEquipment((s) => s.getAllEquipment);
  const equipmentLoading = useEquipment((s) => s.equipmentLoading);

  const [title, setTitle] = useState("");
  const [thumbnailUri, setThumbnailUri] = useState<string | null>(null);
  const [uploading, setUploading] = useState(false);

  const lineHeight = Platform.OS === "ios" ? 0 : 30;

  const onSave = useCallback(async () => {
    if (!title.trim() || equipmentLoading) {
      Toast.show({
        type: "info",
        text1: "Title is required",
      });
      return;
    }

    Keyboard.dismiss();

    try {
      const formData = new FormData();
      formData.append("title", title.trim());

      if (thumbnailUri) {
        setUploading(true);

        const prepared = await prepareImageForUpload(
          {
            uri: thumbnailUri,
            fileName: "equipment.jpg",
            type: "image/jpeg",
          },
          "equipment"
        );

        formData.append("image", prepared as any);
      }

      const res = await createEquipment(formData);

      if (res?.success) {
        Toast.show({
          type: "success",
          text1: "Equipment created successfully",
        });

        await refreshEquipment();
        navigation.goBack();
      } else {
        throw new Error();
      }
    } catch {
      Toast.show({
        type: "error",
        text1: "Failed to create equipment",
      });
    } finally {
      setUploading(false);
    }
  }, [
    title,
    thumbnailUri,
    equipmentLoading,
    createEquipment,
    refreshEquipment,
    navigation,
  ]);

  useEffect(() => {
    (navigation as any).setOptions({
      title: "Add Equipment",
      rightIcons: [
        {
          name: "checkmark-done",
          onPress: onSave,
          disabled: equipmentLoading || !title.trim(),
          color: "green",
        },
      ],
    });
  }, [navigation, onSave, equipmentLoading, title]);

  return (
    <ScrollView
      contentContainerStyle={{ padding: 16, paddingBottom: 40 }}
      className="bg-white dark:bg-black"
    >
      {/* Image picker */}
      <View className="items-center mb-6">
        <ProfilePic
          uri={thumbnailUri}
          size={132}
          editable={!equipmentLoading}
          uploading={uploading}
          onChange={(uri) => uri && setThumbnailUri(uri)}
          shape="circle"
        />
      </View>

      {/* Title input */}
      <View className="flex flex-row items-center gap-8">
        <Text className="text-lg font-semibold text-black dark:text-white">
          Title
        </Text>

        <TextInput
          value={title}
          onChangeText={setTitle}
          editable={!equipmentLoading}
          placeholder="e.g. Barbell"
          className="text-lg text-blue-500"
          placeholderTextColor={isDarkMode ? "#a3a3a3" : "#737373"}
          style={{ lineHeight }}
        />
      </View>
    </ScrollView>
  );
}
